#!/bin/bash

set -eo pipefail

# figure what port the elastic search has bound to
# NOTE: The port may not be the one expected if
# running multiple instances with --net=host.
HOST="$(hostname --ip-address || echo '127.0.0.1')"
PORT=$(lsof -b -i TCP:9200-9299 | grep java | grep 92[0-9][0-9] -o);

# run a basic check
curl --fail --max-time 1 "http://$HOST:$PORT/" || exit 1;

# look for additional, on the container volumes health check scripts
HEALTHD="./var/health";

if [ -d "$HEALTHD" ]
then
    for f in `find "$HEALTHD" -type f -perm /a+x`
		do eval "HOST=\"$HOST\" PORT=\"$PORT\" \"$f\"" || exit 1
    done;
fi;

exit 0
